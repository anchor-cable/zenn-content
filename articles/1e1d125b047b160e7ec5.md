---
title: "負荷試験の勉強兼ねてAurora Serverless v2を試してみました"
emoji: "📌"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["Aurora", "Serverless", "オートスケール"]
published: true
---

# 負荷試験の勉強兼ねてAurora Serverless v2を試してみました

これは12/18の[ゆめみAdvent Calender](https://qiita.com/advent-calendar/2021/yumemi)の記事になります。

## 要約

Aurora Serverless v2を触ってみて、
特にオートスケール周りが非常に便利なサービスだと感じたためその紹介をさせて頂きます。

## Aurora Serverlessとは

https://aws.amazon.com/jp/rds/aurora/serverless/

>Amazon Aurora Serverless は、Amazon Aurora のオンデマンドの Auto Scaling 設定です。
とあるように、インスタンスタイプ他を管理せずに使えるAuroraです。
我々が管理するのは"ACU"(Aurora Capacity Unit)という、メモリ/CPU/Network容量の最小値と最大値のみとなっています。

## オートスケール早いです

![](/images/211217_acu.png)

図は負荷試験シナリオを流した時にACUが1→16になるまでのメトリクスですが、ACUが倍々に増えているのがわかります。

このようにかなりの短時間でスケールアップ・スケールインしてくれるので、もちろん要件次第ではありますがかなりのワークロードに耐えてくれそうです。

## 停止状態からの立ち上げ早いです

![](/images/211217_db.png)

Aurora Serverlessは一定時間操作しなければ停止状態となり、再びアクセスが来た時に立ち上がるようになっています。
どのくらいの時間で停止になるのかは設定があります。

```
$ curl -kL 'http://**.**.**.***/api/sample' -o /dev/null -w "%{time_total}" 2> /dev/null
30.099126
```

v1ではこの停止状態からの立ち上げに1分ほど時間が掛かっていたそうですが、30秒程度でレスポンスが帰って来ています。

## (注意？)ACU増加時に一時的に処理待機が入る

![](/images/211217_gatling.png)

こちらはAurora Serverlessを繋いだLaravelのエンドポイントに負荷を掛けた際のGatlingの結果グラフなのですが、あるタイミングでRPSが下がっていることが分かります。

これはACUが増加したタイミングとぴったり重なります。
また、CPUのメトリクス、キャッシュヒット率を見ると同じタイミングで一時的に減少しているのが分かります。

![](/images/211217_cpu.png)
![](/images/211217_cache.png)

ここから先は確証のない予測ですが、
挙動としては裏側で立ち上がった別のマシンと入れ替わったような挙動を見せています。
予めキャッシュヒット率を高めておくことが前提になるようなサービスだと問題になるかもしれません。

## 最後に

負荷試験の勉強でAurora Serverless側にボトルネックを作ってみようと試みたのですが、
ACUを1に固定してインデックスの効かないクエリを投げる、くらいでしかパフォーマンスが悪くなるような現象を起こせませんでした。
AWS公式としてもv2にはかなり自信があるらしく、v1とv2では以下のようにユースケースの違いが明確です。

v1の場合：
>Amazon Aurora Serverless v1 では、使用頻度が低い、断続的、または予測不能なワークロード向けのシンプルでコスト効率の良いオプションです。

v2の場合
>Aurora Serverless v2 (プレビュー) は、開発およびテスト環境、ウェブサイト、使用頻度が低い、断続的、または予測不能なワークロードを有するアプリケーションから、大規模で高可用性を必要とする最も要求の厳しいビジネスクリティカルなアプリケーションまで、あらゆる態様のデータベースワークロードをサポートします。
